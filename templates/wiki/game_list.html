{% extends 'base.html' %} {% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Filters</h5>
                <p class="card-text">[Filter options will go here]</p>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <ul id="games-list" class="list-group"></ul>
        <div
            class="list-group-item d-flex justify-content-between align-items-center mt-3"
        >
            <button id="load-more-btn" class="btn btn-outline-primary">
                Load More
            </button>
            <div class="pagination">
                <nav aria-label="Page navigation">
                    <ul class="pagination mb-0">
                        <li class="page-item">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">2</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">3</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", initializeGamesList);
    window.addEventListener("resize", updateDescriptions);

    function initializeGamesList() {
        fetchGamesData()
            .then(displayGames)
            .catch((error) => {
                console.error("Failed to fetch games data:", error);
            });
    }

    function fetchGamesData() {
        return fetch("/wiki/api/v1/games").then((response) => {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.json();
        });
    }

    function displayGames(data) {
        const gamesList = document.getElementById("games-list");
        window.gamesData = data;

        data.forEach(function (game, index) {
            const gameItem = createGameItem(game, index);
            gamesList.innerHTML += gameItem;
        });

        data.forEach(function (game, index) {
            createRadarChart(game, index);
        });
    }

    function updateDescriptions() {
        if (!window.gamesData) return;

        const gamesList = document.getElementById("games-list");
        gamesList.innerHTML = "";

        window.gamesData.forEach(function (game, index) {
            const gameItem = createGameItem(game, index);
            gamesList.innerHTML += gameItem;
        });

        window.gamesData.forEach(function (game, index) {
            createRadarChart(game, index);
        });
    }

    function generateTagsBadges(tags) {
        return tags
            .map((tag) => `<span class="badge bg-secondary me-1">${tag}</span>`)
            .join("");
    }

    function generateAgeGroupBadges(ageGroups) {
        return ageGroups
            .map((age) => `<span class="badge bg-info me-1">${age}</span>`)
            .join("");
    }

    function createGameItem(game, index) {
        const shortDesc = truncateDescription(game.short_description);
        const voteData = generateRandomVotes();
        const badgeClass = getVoteBadgeClass(
            voteData.upvotes,
            voteData.downvotes,
        );
        const positivePercentage = calculatePositivePercentage(
            voteData.upvotes,
            voteData.downvotes,
        );

        const tagsHtml = generateTagsBadges(game.tags);
        const ageGroupsHtml = generateAgeGroupBadges(game.age_groups);

        return `
        <li class="list-group-item" onclick="window.location='/wiki/games/${game.id}'" style="cursor: pointer;">
            <div class="row">
                <div class="col-xl-8 col-lg-6 order-md-1 order-1">
                    <h5>${game.title}</h5>
                    <div class="mb-2">
                        ${tagsHtml}
                        ${ageGroupsHtml}
                    </div>
                    <p>${shortDesc}</p>

                </div>

                <div class="col-xl-4 col-lg-6 order-2 mb-3 mb-md-0">
                    <canvas id="radar-chart-${index}" width="150" height="125"></canvas>
                </div>

                <div class="col-xl-8 col-lg-6 order-3 mt-2 mt-md-0">
                    <div class="vote-ratio">
                        <small class="text-muted">
                            <i class="fas fa-arrow-up"></i> ${voteData.upvotes}
                            <i class="fas fa-arrow-down"></i> ${voteData.downvotes}
                            <span class="badge ${badgeClass} ms-1">
                                ${positivePercentage}% positive
                            </span>
                        </small>
                    </div>
                </div>
            </div>
        </li>
          `;
    }

    function createRadarChart(game, index) {
        const ctx = document
            .getElementById(`radar-chart-${index}`)
            .getContext("2d");

        new Chart(ctx, {
            type: "radar",
            data: {
                labels: [
                    "Difficulty",
                    "Preperation",
                    "Physical",
                    "Duration",
                    "Group Size",
                ],
                datasets: [
                    {
                        label: "Game Metrics",
                        data: [
                            game.difficulty_index,
                            game.preperation_index,
                            game.physical_index,
                            game.duration_index,
                            game.group_size_index,
                        ],
                        fill: true,
                        backgroundColor: "rgba(54, 162, 235, 0.2)",
                        borderColor: "rgb(54, 162, 235)",
                        pointBackgroundColor: "rgb(54, 162, 235)",
                        pointBorderColor: "#fff",
                        pointHoverBackgroundColor: "#fff",
                        pointHoverBorderColor: "rgb(54, 162, 235)",
                    },
                ],
            },
            options: {
                elements: {
                    line: {
                        borderWidth: 1,
                    },
                },
                scales: {
                    r: {
                        angleLines: {
                            display: true,
                        },
                        suggestedMin: 0,
                        suggestedMax: 10,
                        ticks: {
                            display: false,
                            stepSize: 2,
                        },
                    },
                },
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        enabled: true,
                    },
                },
                maintainAspectRatio: false,
            },
        });
    }

    function generateGameMetrics() {
        return {
            difficultyComplexity: Math.floor(Math.random() * 10) + 1,
            preparationTime: Math.floor(Math.random() * 10) + 1,
            physicalIntensity: Math.floor(Math.random() * 10) + 1,
            duration: Math.floor(Math.random() * 10) + 1,
            groupSizeFlexibility: Math.floor(Math.random() * 10) + 1,
        };
    }

    function truncateDescription(description) {
        const viewportWidth = window.innerWidth;
        let maxLength;

        if (viewportWidth <= 576) {
            maxLength = 80;
        } else if (viewportWidth <= 768) {
            maxLength = 80;
        } else if (viewportWidth <= 992) {
            maxLength = 130;
        } else if (viewportWidth <= 1200) {
            maxLength = 140;
        } else {
            maxLength = 190;
        }

        return description.length > maxLength
            ? description.substring(0, maxLength - 3) + "..."
            : description;
    }

    function generateRandomVotes() {
        return {
            upvotes: Math.floor(Math.random() * 1000) + 1,
            downvotes: Math.floor(Math.random() * 300) + 1,
        };
    }

    function calculatePositivePercentage(upvotes, downvotes) {
        return Math.round((upvotes / (upvotes + downvotes)) * 100);
    }

    function getVoteBadgeClass(upvotes, downvotes) {
        const percentage = calculatePositivePercentage(upvotes, downvotes);

        if (percentage > 75) {
            return "bg-success";
        } else if (percentage > 50) {
            return "bg-warning";
        } else {
            return "bg-danger";
        }
    }
</script>
{% endblock %} {% block title %}Game Wiki | Massive Game Archive{% endblock %}
