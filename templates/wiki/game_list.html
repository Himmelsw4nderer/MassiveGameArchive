{% extends 'base.html' %} {% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="input-group">
            <input
                type="text"
                class="form-control"
                placeholder="Search games..."
                id="gameSearch"
            />
            <button class="btn btn-primary" type="button" id="searchButton">
                <i class="fas fa-search"></i> Search
            </button>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Filters</h5>
                <div class="filter-section">
                    <h6
                        class="filter-heading"
                        data-bs-toggle="collapse"
                        href="#sortCollapse"
                        role="button"
                    >
                        <i class="fas fa-chevron-down me-1"></i> Sort By
                    </h6>
                    <div class="collapse show" id="sortCollapse">
                        <div class="px-2 py-2">
                            <select class="form-select" id="sortBySelect">
                                <option value="relevance" selected>
                                    Relevance
                                </option>
                                <option value="newest">Newest</option>
                                <option value="popular">Most Popular</option>
                                <option value="rating">Highest Rated</option>
                                <option value="alphabetical">
                                    Alphabetical
                                </option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="filter-section mt-3">
                    <h6
                        class="filter-heading"
                        data-bs-toggle="collapse"
                        href="#tagCollapse"
                        role="button"
                    >
                        <i class="fas fa-chevron-down me-1"></i> Game Tags
                    </h6>
                    <div class="collapse show" id="tagCollapse">
                        <ul class="list-group">
                            {% for tag in tags %}
                            <li
                                class="list-group-item d-flex justify-content-between align-items-center"
                            >
                                <div class="form-check">
                                    <input
                                        class="form-check-input tag-filter"
                                        type="checkbox"
                                        value="{{ tag }}"
                                        id="tag{{ tag }}"
                                    />
                                    <label
                                        class="form-check-label"
                                        for="tag{{ tag }}"
                                        >{{ tag }}</label
                                    >
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <div class="filter-section mt-3">
                    <h6
                        class="filter-heading"
                        data-bs-toggle="collapse"
                        href="#ageCollapse"
                        role="button"
                    >
                        <i class="fas fa-chevron-down me-1"></i> Age Groups
                    </h6>
                    <div class="collapse show" id="ageCollapse">
                        <ul class="list-group">
                            {% for age_group in age_groups %}
                            <li
                                class="list-group-item d-flex justify-content-between align-items-center"
                            >
                                <div class="form-check">
                                    <input
                                        class="form-check-input age-filter"
                                        type="checkbox"
                                        value="{{ age_group }}"
                                        id="age{{ age_group }}"
                                    />
                                    <label
                                        class="form-check-label"
                                        for="age{{ age_group }}"
                                        >{{ age_group }}</label
                                    >
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <div class="filter-section mt-3">
                    <h6
                        class="filter-heading"
                        data-bs-toggle="collapse"
                        href="#difficultyCollapse"
                        role="button"
                    >
                        <i class="fas fa-chevron-down me-1"></i> Difficulty
                        Level
                    </h6>
                    <div class="collapse show" id="difficultyCollapse">
                        <div class="px-2 py-2">
                            <label
                                for="difficultyRange"
                                class="form-label d-flex justify-content-between"
                            >
                                <span
                                    >Min:
                                    <span id="difficultyMin">1</span></span
                                >
                                <span
                                    >Max:
                                    <span id="difficultyMax">10</span></span
                                >
                            </label>
                            <div id="difficultyRange" class="mt-2"></div>
                        </div>
                    </div>
                </div>

                <div class="filter-section mt-3">
                    <h6
                        class="filter-heading"
                        data-bs-toggle="collapse"
                        href="#preparationCollapse"
                        role="button"
                    >
                        <i class="fas fa-chevron-down me-1"></i> Preparation
                    </h6>
                    <div class="collapse show" id="preparationCollapse">
                        <div class="px-2 py-2">
                            <label
                                for="preparationRange"
                                class="form-label d-flex justify-content-between"
                            >
                                <span
                                    >Min:
                                    <span id="preparationMin">1</span></span
                                >
                                <span
                                    >Max:
                                    <span id="preparationMax">10</span></span
                                >
                            </label>
                            <div id="preparationRange" class="mt-2"></div>
                        </div>
                    </div>
                </div>

                <div class="filter-section mt-3">
                    <h6
                        class="filter-heading"
                        data-bs-toggle="collapse"
                        href="#physicalCollapse"
                        role="button"
                    >
                        <i class="fas fa-chevron-down me-1"></i> Physical
                    </h6>
                    <div class="collapse show" id="physicalCollapse">
                        <div class="px-2 py-2">
                            <label
                                for="physicalRange"
                                class="form-label d-flex justify-content-between"
                            >
                                <span
                                    >Min: <span id="physicalMin">1</span></span
                                >
                                <span
                                    >Max: <span id="physicalMax">10</span></span
                                >
                            </label>
                            <div id="physicalRange" class="mt-2"></div>
                        </div>
                    </div>
                </div>

                <div class="filter-section mt-3">
                    <h6
                        class="filter-heading"
                        data-bs-toggle="collapse"
                        href="#durationCollapse"
                        role="button"
                    >
                        <i class="fas fa-chevron-down me-1"></i> Duration
                    </h6>
                    <div class="collapse show" id="durationCollapse">
                        <div class="px-2 py-2">
                            <label
                                for="durationRange"
                                class="form-label d-flex justify-content-between"
                            >
                                <span
                                    >Min: <span id="durationMin">1</span></span
                                >
                                <span
                                    >Max: <span id="durationMax">10</span></span
                                >
                            </label>
                            <div id="durationRange" class="mt-2"></div>
                        </div>
                    </div>
                </div>

                <div class="filter-section mt-3">
                    <h6
                        class="filter-heading"
                        data-bs-toggle="collapse"
                        href="#groupSizeCollapse"
                        role="button"
                    >
                        <i class="fas fa-chevron-down me-1"></i> Group Size
                    </h6>
                    <div class="collapse show" id="groupSizeCollapse">
                        <div class="px-2 py-2">
                            <label
                                for="groupSizeRange"
                                class="form-label d-flex justify-content-between"
                            >
                                <span
                                    >Min: <span id="groupSizeMin">1</span></span
                                >
                                <span
                                    >Max:
                                    <span id="groupSizeMax">10</span></span
                                >
                            </label>
                            <div id="groupSizeRange" class="mt-2"></div>
                        </div>
                    </div>
                </div>

                <button id="applyFilters" class="btn btn-primary w-100 mt-3">
                    Apply Filters
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <ul id="games-list" class="list-group"></ul>
        <div
            class="list-group-item d-flex justify-content-between align-items-center mt-3"
        >
            <button id="load-more-btn" class="btn btn-outline-primary">
                Load More
            </button>
            <div class="pagination">
                <nav aria-label="Page navigation">
                    <ul class="pagination mb-0">
                        <li class="page-item">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">2</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">3</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        initializeSliders();
        initializeGamesList();

        document
            .getElementById("applyFilters")
            .addEventListener("click", function () {
                document.getElementById("games-list").innerHTML = "";

                fetchGamesWithFilters()
                    .then(displayGames)
                    .catch((error) => {
                        console.error(
                            "Failed to fetch filtered games data:",
                            error,
                        );
                    });
            });

        document
            .getElementById("searchButton")
            .addEventListener("click", function () {
                document.getElementById("games-list").innerHTML = "";

                fetchGamesWithFilters()
                    .then(displayGames)
                    .catch((error) => {
                        console.error("Failed to search games data:", error);
                    });
            });

        document
            .getElementById("gameSearch")
            .addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    document.getElementById("games-list").innerHTML = "";

                    fetchGamesWithFilters()
                        .then(displayGames)
                        .catch((error) => {
                            console.error(
                                "Failed to search games data:",
                                error,
                            );
                        });
                }
            });
    });
    window.addEventListener("resize", updateDescriptions);

    function initializeSliders() {
        const sliders = [
            {
                id: "difficultyRange",
                minId: "difficultyMin",
                maxId: "difficultyMax",
            },
            {
                id: "preparationRange",
                minId: "preparationMin",
                maxId: "preparationMax",
            },
            { id: "physicalRange", minId: "physicalMin", maxId: "physicalMax" },
            { id: "durationRange", minId: "durationMin", maxId: "durationMax" },
            {
                id: "groupSizeRange",
                minId: "groupSizeMin",
                maxId: "groupSizeMax",
            },
        ];

        sliders.forEach((slider) => {
            const element = document.getElementById(slider.id);
            if (element) {
                noUiSlider.create(element, {
                    start: [1, 10],
                    connect: true,
                    step: 1,
                    range: {
                        min: 1,
                        max: 10,
                    },
                });

                const minElement = document.getElementById(slider.minId);
                const maxElement = document.getElementById(slider.maxId);

                element.noUiSlider.on("update", function (values, handle) {
                    const value = Math.round(values[handle]);
                    if (handle === 0) {
                        minElement.innerText = value;
                    } else {
                        maxElement.innerText = value;
                    }
                });
            }
        });
    }

    function initializeGamesList() {
        fetchGamesWithFilters()
            .then(displayGames)
            .catch((error) => {
                console.error("Failed to fetch games data:", error);
            });
    }

    function getSelectedValues(className) {
        const checkboxes = document.querySelectorAll(className + ":checked");
        return Array.from(checkboxes).map((checkbox) => checkbox.value);
    }

    function fetchGamesWithFilters() {
        const tagFilters = getSelectedValues(".tag-filter");
        const ageGroupFilters = getSelectedValues(".age-filter");

        const difficultyValues = document
            .getElementById("difficultyRange")
            .noUiSlider.get();
        const preparationValues = document
            .getElementById("preparationRange")
            .noUiSlider.get();
        const physicalValues = document
            .getElementById("physicalRange")
            .noUiSlider.get();
        const durationValues = document
            .getElementById("durationRange")
            .noUiSlider.get();
        const groupSizeValues = document
            .getElementById("groupSizeRange")
            .noUiSlider.get();

        const searchTerm = document.getElementById("gameSearch").value;
        const sortBy = document.getElementById("sortBySelect").value;

        currentPage = 0;

        let params = new URLSearchParams();

        if (tagFilters.length > 0) {
            tagFilters.forEach((tag) => params.append("tag_filter", tag));
        }

        if (ageGroupFilters.length > 0) {
            ageGroupFilters.forEach((age) =>
                params.append("age_group_filter", age),
            );
        }

        params.append("min_difficulty_index", Math.round(difficultyValues[0]));
        params.append("max_difficulty_index", Math.round(difficultyValues[1]));

        params.append(
            "min_preperation_index",
            Math.round(preparationValues[0]),
        );
        params.append(
            "max_preperation_index",
            Math.round(preparationValues[1]),
        );

        params.append("min_physical_index", Math.round(physicalValues[0]));
        params.append("max_physical_index", Math.round(physicalValues[1]));

        params.append("min_duration_index", Math.round(durationValues[0]));
        params.append("max_duration_index", Math.round(durationValues[1]));

        params.append("min_group_size_index", Math.round(groupSizeValues[0]));
        params.append("max_group_size_index", Math.round(groupSizeValues[1]));

        if (searchTerm) {
            params.append("q", searchTerm);
            lastSearchTerm = searchTerm;
        }

        params.append("sort_by", sortBy);
        params.append("start_index", 0);
        params.append("amount", 20);

        return fetch(`/wiki/api/v1/games?${params.toString()}`).then(
            (response) => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            },
        );
    }

    function displayGames(data) {
        const gamesList = document.getElementById("games-list");
        gamesList.innerHTML = ""; // Clear existing content
        window.gamesData = data;

        if (data.length === 0) {
            gamesList.innerHTML =
                '<div class="alert alert-info">No games match your filters</div>';
            return;
        }

        data.forEach(function (game, index) {
            const gameItem = createGameItem(game, index);
            gamesList.innerHTML += gameItem;
        });

        data.forEach(function (game, index) {
            createRadarChart(game, index);
        });
    }

    function updateDescriptions() {
        if (!window.gamesData) return;

        const gamesList = document.getElementById("games-list");
        gamesList.innerHTML = "";

        window.gamesData.forEach(function (game, index) {
            const gameItem = createGameItem(game, index);
            gamesList.innerHTML += gameItem;
        });

        window.gamesData.forEach(function (game, index) {
            createRadarChart(game, index);
        });
    }

    function generateTagsBadges(tags) {
        return tags
            .map((tag) => `<span class="badge bg-primary me-1">${tag}</span>`)
            .join("");
    }

    function generateAgeGroupBadges(ageGroups) {
        return ageGroups
            .map((age) => `<span class="badge bg-info me-1">${age}</span>`)
            .join("");
    }

    function createGameItem(game, index) {
        const shortDesc = truncateDescription(game.short_description);

        const positivePercentage = calculatePositivePercentage(
            game.upvote_count,
            game.downvote_count,
        );
        const badgeClass = getVoteBadgeClass(positivePercentage);
        const positivePercentageDisplay = isNaN(positivePercentage)
            ? "No Votes"
            : `${positivePercentage}% Positive`;

        const tagsHtml = generateTagsBadges(game.tags);
        const ageGroupsHtml = generateAgeGroupBadges(game.age_groups);

        return `
        <li class="list-group-item" onclick="window.location='/wiki/games/${game.id}'" style="cursor: pointer;">
            <div class="row">
                <div class="col-xl-8 col-lg-6 order-md-1 order-1">
                    <h5>${game.title}</h5>
                    <div class="mb-2">
                        ${tagsHtml}
                        ${ageGroupsHtml}
                    </div>
                    <p>${shortDesc}</p>

                </div>

                <div class="col-xl-4 col-lg-6 order-2 mb-3 mb-md-0">
                    <canvas id="radar-chart-${index}" width="150" height="125"></canvas>
                </div>

                <div class="col-xl-8 col-lg-6 order-3 mt-2 mt-md-0">
                    <div class="vote-ratio">
                        <small class="text-muted">
                            <i class="fas fa-arrow-up"></i> ${game.upvote_count}
                            <i class="fas fa-arrow-down"></i> ${game.downvote_count}
                            <span class="badge ${badgeClass} ms-1">
                                ${positivePercentageDisplay}
                            </span>
                        </small>
                    </div>
                </div>
            </div>
        </li>
          `;
    }

    function createRadarChart(game, index) {
        const ctx = document
            .getElementById(`radar-chart-${index}`)
            .getContext("2d");

        new Chart(ctx, {
            type: "radar",
            data: {
                labels: [
                    "Difficulty",
                    "Preperation",
                    "Physical",
                    "Duration",
                    "Group Size",
                ],
                datasets: [
                    {
                        label: "Game Metrics",
                        data: [
                            game.difficulty_index,
                            game.preperation_index,
                            game.physical_index,
                            game.duration_index,
                            game.group_size_index,
                        ],
                        fill: true,
                        backgroundColor: "rgba(54, 162, 235, 0.2)",
                        borderColor: "rgb(54, 162, 235)",
                        pointBackgroundColor: "rgb(54, 162, 235)",
                        pointBorderColor: "#fff",
                        pointHoverBackgroundColor: "#fff",
                        pointHoverBorderColor: "rgb(54, 162, 235)",
                    },
                ],
            },
            options: {
                elements: {
                    line: {
                        borderWidth: 1,
                    },
                },
                scales: {
                    r: {
                        angleLines: {
                            display: true,
                        },
                        suggestedMin: 0,
                        suggestedMax: 10,
                        ticks: {
                            display: false,
                            stepSize: 2,
                        },
                    },
                },
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        enabled: true,
                    },
                },
                maintainAspectRatio: false,
            },
        });
    }

    function truncateDescription(description) {
        const viewportWidth = window.innerWidth;
        let maxLength;

        if (viewportWidth <= 576) {
            maxLength = 80;
        } else if (viewportWidth <= 768) {
            maxLength = 80;
        } else if (viewportWidth <= 992) {
            maxLength = 130;
        } else if (viewportWidth <= 1200) {
            maxLength = 140;
        } else {
            maxLength = 190;
        }

        return description.length > maxLength
            ? description.substring(0, maxLength - 3) + "..."
            : description;
    }

    function calculatePositivePercentage(upvotes, downvotes) {
        return Math.round((upvotes / (upvotes + downvotes)) * 100);
    }

    function getVoteBadgeClass(percentage) {
        if (percentage > 75) {
            return "bg-success";
        } else if (percentage > 50) {
            return "bg-warning";
        } else if (percentage <= 50) {
            return "bg-danger";
        } else {
            return "bg-secondary";
        }
    }
</script>
{% endblock %} {% block title %}Game Wiki | Massive Game Archive{% endblock %}
