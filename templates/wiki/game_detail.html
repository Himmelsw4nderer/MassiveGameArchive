{% extends 'base.html' %}

{% block title %}{{ game.title }} - Wiki{% endblock %}

{% block extra_css %}
<style>
    .game-header {
        background-color: #f8f9fa;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0.5rem;
    }
    
    .game-metadata {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin: 1.5rem 0;
    }
    
    .badge-age {
        background-color: #17a2b8;
    }
    
    .badge-players {
        background-color: #6f42c1;
    }
    
    .badge-duration {
        background-color: #fd7e14;
    }
    
    .badge-difficulty {
        background-color: #20c997;
    }
    
    .rating-stars {
        color: #ffc107;
        font-size: 1.25rem;
    }
    
    .game-images {
        margin-bottom: 2rem;
    }
    
    .game-image-thumb {
        cursor: pointer;
        height: 100px;
        object-fit: cover;
        border: 2px solid transparent;
        border-radius: 0.25rem;
        transition: all 0.2s ease;
    }
    
    .game-image-thumb.active {
        border-color: #0d6efd;
    }
    
    .tab-content {
        padding: 1.5rem;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-top: 0;
        border-radius: 0 0 0.5rem 0.5rem;
    }
    
    .material-list li {
        margin-bottom: 0.75rem;
    }
    
    .material-required {
        color: #dc3545;
    }
    
    .material-optional {
        color: #6c757d;
    }
    
    .variant-card {
        margin-bottom: 1.5rem;
    }
    
    .review-card {
        margin-bottom: 1.5rem;
    }
    
    .review-author {
        font-weight: bold;
    }
    
    .review-date {
        font-size: 0.85rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="{% url 'wiki:game_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i> Zurück zur Spieleliste
        </a>
    </div>
    
    <!-- Game Header -->
    <div class="game-header">
        <div class="container">
            <div class="row">
                <div class="col-md-9">
                    <h1 class="display-5">{{ game.title }}</h1>
                    
                    <div class="mb-3">
                        {% for category in game.categories.all %}
                        <span class="badge bg-secondary mb-1 me-1">{{ category.name }}</span>
                        {% endfor %}
                    </div>
                    
                    <div class="game-metadata">
                        {% for age_group in game.age_groups.all %}
                        <span class="badge badge-age py-2 px-3">
                            <i class="fas fa-child me-1"></i> 
                            {{ age_group.min_age }}{% if age_group.max_age %}–{{ age_group.max_age }}{% endif %} Jahre
                        </span>
                        {% endfor %}
                        
                        <span class="badge badge-players py-2 px-3">
                            <i class="fas fa-users me-1"></i> 
                            {{ game.min_players }}{% if game.max_players %}–{{ game.max_players }}{% endif %} Spieler
                        </span>
                        
                        <span class="badge badge-duration py-2 px-3">
                            <i class="far fa-clock me-1"></i> 
                            {{ game.duration }} Min
                        </span>
                        
                        <span class="badge badge-difficulty py-2 px-3">
                            <i class="fas fa-signal me-1"></i> 
                            {{ game.get_difficulty_display }}
                        </span>
                        
                        {% if game.indoor %}
                        <span class="badge bg-success py-2 px-3">
                            <i class="fas fa-home me-1"></i> Innen
                        </span>
                        {% endif %}
                        
                        {% if game.outdoor %}
                        <span class="badge bg-primary py-2 px-3">
                            <i class="fas fa-tree me-1"></i> Außen
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="rating-stars mb-2">
                        {% for i in "12345" %}
                        {% if forloop.counter <= game.avg_rating|floatformat:"0" %}
                        <i class="fas fa-star"></i>
                        {% elif forloop.counter <= game.avg_rating|add:"0.5"|floatformat:"0" %}
                        <i class="fas fa-star-half-alt"></i>
                        {% else %}
                        <i class="far fa-star"></i>
                        {% endif %}
                        {% endfor %}
                        <span class="text-muted ms-2">{{ game.avg_rating|floatformat:1 }} ({{ game.rating_count }} Bewertungen)</span>
                    </div>
                </div>
                
                <div class="col-md-3 text-md-end">
                    <div class="d-flex flex-column align-items-md-end mt-3 mt-md-0">
                        <div class="text-muted mb-2">Erstellt am {{ game.created_at|date:"d.m.Y" }}</div>
                        <div class="text-muted">von {{ game.created_by.username }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Game Images -->
            {% if game.images.exists %}
            <div class="game-images mb-4">
                <div class="mb-3">
                    <img src="{{ game.images.first.image.url }}" class="img-fluid rounded main-image" alt="{{ game.title }}">
                </div>
                
                <div class="row g-3">
                    {% for image in game.images.all %}
                    <div class="col-3">
                        <img src="{{ image.image.url }}" class="game-image-thumb w-100 {% if forloop.first %}active{% endif %}" 
                             alt="{{ image.caption|default:game.title }}" data-src="{{ image.image.url }}">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Game Details Tabs -->
            <ul class="nav nav-tabs" id="gameDetailTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" 
                            type="button" role="tab" aria-controls="description" aria-selected="true">Beschreibung</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" 
                            type="button" role="tab" aria-controls="rules" aria-selected="false">Spielregeln</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="preparation-tab" data-bs-toggle="tab" data-bs-target="#preparation" 
                            type="button" role="tab" aria-controls="preparation" aria-selected="false">Vorbereitung</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tips-tab" data-bs-toggle="tab" data-bs-target="#tips" 
                            type="button" role="tab" aria-controls="tips" aria-selected="false">Tipps</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="variants-tab" data-bs-toggle="tab" data-bs-target="#variants" 
                            type="button" role="tab" aria-controls="variants" aria-selected="false">Varianten</button>
                </li>
            </ul>
            <div class="tab-content mb-5" id="gameDetailTabsContent">
                <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
                    <div class="formatted-text">{{ game.description|linebreaksbr }}</div>
                </div>
                <div class="tab-pane fade" id="rules" role="tabpanel" aria-labelledby="rules-tab">
                    <div class="formatted-text">{{ game.rules|linebreaksbr }}</div>
                </div>
                <div class="tab-pane fade" id="preparation" role="tabpanel" aria-labelledby="preparation-tab">
                    {% if game.preparation %}
                    <div class="formatted-text">{{ game.preparation|linebreaksbr }}</div>
                    {% else %}
                    <div class="alert alert-light">Keine Vorbereitungshinweise vorhanden.</div>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="tips" role="tabpanel" aria-labelledby="tips-tab">
                    {% if game.tips %}
                    <div class="formatted-text">{{ game.tips|linebreaksbr }}</div>
                    {% else %}
                    <div class="alert alert-light">Keine Tipps vorhanden.</div>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="variants" role="tabpanel" aria-labelledby="variants-tab">
                    {% if game.variants.exists %}
                        {% for variant in game.variants.all %}
                        <div class="card variant-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">{{ variant.title }}</h5>
                                <small class="text-muted">von {{ variant.created_by.username }}</small>
                            </div>
                            <div class="card-body">
                                {{ variant.description|linebreaksbr }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-light">Keine Spielvarianten vorhanden.</div>
                        {% if user.is_authenticated %}
                        <a href="#" class="btn btn-outline-primary">
                            <i class="fas fa-plus-circle me-2"></i> Neue Variante hinzufügen
                        </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            
            <!-- Reviews Section -->
            <h3 class="mb-4">Bewertungen und Kommentare</h3>
            
            {% if user.is_authenticated %}
            <div class="card mb-4">
                <div class="card-header">
                    Deine Bewertung
                </div>
                <div class="card-body">
                    <!-- Rating Form -->
                    <form method="post" action="{% url 'wiki:rate_game' slug=game.slug %}">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label">Bewertung</label>
                            <div class="rating-input">
                                {% for i in "12345" %}
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="rating" id="rating{{ i }}" value="{{ i }}" 
                                           {% if user_rating and user_rating.rating == forloop.counter %}checked{% endif %}>
                                    <label class="form-check-label" for="rating{{ i }}">{{ i }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="review" class="form-label">Kommentar (optional)</label>
                            <textarea class="form-control" id="review" name="review" rows="3">{{ user_rating.review|default:'' }}</textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Bewertung abschicken</button>
                    </form>
                </div>
            </div>
            {% endif %}
            
            <!-- Reviews List -->
            {% if game.ratings.exists %}
            <div class="reviews-list">
                {% for rating in game.ratings.all %}
                <div class="card review-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <span class="review-author">{{ rating.user.username }}</span>
                                <span class="review-date ms-2">{{ rating.created_at|date:"d.m.Y" }}</span>
                            </div>
                            <div class="rating-stars">
                                {% for i in "12345" %}
                                {% if forloop.counter <= rating.rating %}
                                <i class="fas fa-star"></i>
                                {% else %}
                                <i class="far fa-star"></i>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% if rating.review %}
                        <p class="card-text">{{ rating.review|linebreaksbr }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-light">
                Noch keine Bewertungen vorhanden. Sei der Erste, der dieses Spiel bewertet!
            </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Materials -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Benötigte Materialien</h4>
                </div>
                <div class="card-body">
                    {% if game.gamematerialrequirement_set.exists %}
                    <ul class="list-unstyled material-list">
                        {% for req in game.gamematerialrequirement_set.all %}
                        <li>
                            {% if req.required %}
                            <span class="material-required"><i class="fas fa-check-circle me-2"></i></span>
                            {% else %}
                            <span class="material-optional"><i class="fas fa-circle me-2"></i></span>
                            {% endif %}
                            
                            <strong>{{ req.material.name }}</strong>
                            {% if req.quantity %}<span class="text-muted">({{ req.quantity }})</span>{% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    <div class="mt-3 small">
                        <div><span class="material-required"><i class="fas fa-check-circle me-2"></i></span> Erforderlich</div>
                        <div><span class="material-optional"><i class="fas fa-circle me-2"></i></span> Optional</div>
                    </div>
                    {% else %}
                    <p class="text-muted">Keine spezifischen Materialien erforderlich.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Related Games -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Ähnliche Spiele</h4>
                </div>
                <div class="card-body">
                    {% if related_games %}
                    <div class="list-group list-group-flush">
                        {% for related in related_games %}
                        <a href="{{ related.get_absolute_url }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                {{ related.title }}
                                <div class="text-muted small">
                                    {{ related.min_players }}{% if related.max_players %}-{{ related.max_players }}{% endif %} Spieler | {{ related.duration }} Min
                                </div>
                            </div>
                            <span class="rating-stars small">
                                {% for i in "12345" %}
                                {% if forloop.counter <= related.avg_rating|floatformat:"0" %}
                                <i class="fas fa-star"></i>
                                {% else %}
                                <i class="far fa-star"></i>
                                {% endif %}
                                {% endfor %}
                            </span>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">Keine ähnlichen Spiele gefunden.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Aktionen</h4>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary">
                            <i class="far fa-bookmark me-2"></i> Als Favorit speichern
                        </button>
                        <button class="btn btn-outline-primary">
                            <i class="fas fa-print me-2"></i> Drucken
                        </button>
                        <button class="btn btn-outline-primary">
                            <i class="fas fa-share-alt me-2"></i> Teilen
                        </button>
                        {% if user.is_authenticated %}
                            {% if user == game.created_by or user.is_staff %}
                            <a href="{% url 'wiki:edit_game' slug=game.slug %}" class="btn btn-outline-secondary">
                                <i class="fas fa-edit me-2"></i> Bearbeiten
                            </a>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Font Awesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script>
    // Image gallery functionality
    document.addEventListener('DOMContentLoaded', function() {
        const mainImage = document.querySelector('.main-image');
        const thumbs = document.querySelectorAll('.game-image-thumb');
        
        if (mainImage && thumbs.length > 0) {
            thumbs.forEach(thumb => {
                thumb.addEventListener('click', function() {
                    // Update main image
                    mainImage.src = this.dataset.src;
                    
                    // Update active state
                    thumbs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
    });
</script>
{% endblock %}